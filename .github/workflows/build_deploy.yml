name: Build and Deploy
on:
  push:
    branches:
      - gh-pages-config-test
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
      - name: Use Node.js 16
        uses: actions/setup-node@v2
        with:
          node-version: 16
          cache: "yarn"
      - name: Install and Build 🔧
        run: |
          yarn install
          yarn build
      - name: Deploy 🚀
        env:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          # set -ex
          # # use the generated token to autheticate the action
          # git remote set-url origin https://TomHedges:${ACCESS_TOKEN}@github.com/TomHedges/twitter-rank.git 
          # # split of the subtree at frontend/dist (or wherever your frontend is located) and force push it to the gh-pages branch
          # git push origin `git subtree split --prefix public gh-pages-config-test`:published --force
          # just to get us all at the same starting point
          #
          # delete your build folder
          rm -rf dist/
          # create a 'build' directory checked out to the published branch
          git worktree add -B published dist origin/published
          # build the project
          yarn build
          # cd into 'build' folder, which is now on the published branch
          cd dist
          # fail if for some reason this isn't the published branch
          current_branch=$(git symbolic-ref --short -q HEAD)
          if [ "$current_branch" != "published" ]; then
            echo "Expected dist folder to be on published branch."
            exit 1
          fi
          # change .gitignore
          # sed -i '' '/dist/d' .gitignore
          # commit and push to published
          git add . && git commit -m "Update published site"
          git push
